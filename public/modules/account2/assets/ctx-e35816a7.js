var B=Object.defineProperty,U=Object.defineProperties;var q=Object.getOwnPropertyDescriptors;var A=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,N=Object.prototype.propertyIsEnumerable;var k=(e,t,a)=>t in e?B(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,v=(e,t)=>{for(var a in t||(t={}))F.call(t,a)&&k(e,a,t[a]);if(A)for(var a of A(t))N.call(t,a)&&k(e,a,t[a]);return e},$=(e,t)=>U(e,q(t));var d=(e,t,a)=>new Promise((r,o)=>{var c=n=>{try{i(a.next(n))}catch(g){o(g)}},s=n=>{try{i(a.throw(n))}catch(g){o(g)}},i=n=>n.done?r(n.value):Promise.resolve(n.value).then(c,s);i((a=a.apply(e,t)).next())});import{j as O,f as H,e as D}from"./solid-js-c760dca1.js";import{c as j}from"./store-53c53def.js";import{e as u,d as m,f,t as y,c as _,g as h,Q as P,p as L,P as x,B as E,b as M,u as z,R as G}from"./manifest-085c1252.js";import{f as K}from"./utils-de8488f6.js";import{t as w,c as S,i as Q,a as Y}from"./i18n-c89f3d65.js";const R=function(){return _.loadScript("https://telegram.org/js/telegram-web-app.js","Telegram")};function J(e,t,a){return d(this,null,function*(){const r=new URLSearchParams;for(const o in t)t[o]!==void 0&&t[o]!==""&&r.append(o,String(t[o]));try{yield h().get(`/account/open/telegram/login-callback/?${r.toString()}${a?`&${a}`:""}`),yield P(),e()}catch(o){y(o)}})}function ue(e){return d(this,null,function*(){var o;const t=u.initHashParams,a=t.startsWith("#")?t.substring(1):t;if(new URLSearchParams(a).has("tgWebAppData")){window.location.hash=t;const c=yield R();if(m.login)return;try{const s=(o=c.WebApp)==null?void 0:o.initData;f.emit("sensorsTrack",{event:"third_register_click",account_type:"telegram"}),f.emit("track_third_register",{account_type:"telegram"}),yield J(e,{invitationCode:u.initSearchParams.get("i")||"",loginSource:"miniApp"},s)}catch(s){console.error(s),y(s)}}})}function V(){return d(this,null,function*(){var r;const e=u.initHashParams,t=e.startsWith("#")?e.substring(1):e;if(new URLSearchParams(t).has("tgWebAppData")){window.location.hash=e;const c=(r=(yield R()).WebApp)==null?void 0:r.initData;try{yield h().get(`/account/open/telegram/bind/?${c}&loginSource=miniApp`),yield P(),y(w("Youâ€™re all set! Next time, you can now log in with your Telegram account for quick access.")),L.pop()}catch(s){y(s)}}})}var X=Y("<p class=text-center>");const Z=function(){return S(x,{get title(){return w("Authorize Login with Telegram")},get children(){return[(()=>{var t=X();return Q(t,()=>w("Connect @Tg_id for a quicker, password-free login in the future.")),t})(),S(E,{class:"my-4 w-full",type:"brand",onClick:V,get children(){return w("Authorize")}})]}})};function ee(){return d(this,null,function*(){try{let e=!1;const t=yield h().get("/account/open/info/list/");if(t){const a=t.find(r=>r.openName==="telegram");a&&a.connected&&(e=!0)}e||L.push(()=>S(Z,{}))}catch(e){}})}const te={areaCode:"1",countryCode:"CA",en:"Canada",value:"1"},ge=/^(?!\d{3}\1{3}\1{3}\1{2}$)(\d{3}\.?\d{3}\.?\d{3}-?\d{2})$/;function ae(){const{isKenyaHost:e,isUsHost:t}=_.getHostType(u.host),[a,r]=j({inIframe:window.location.search.includes("type=iframe"),areaCode:te,emailOrPhone:"",password:"",invitationCode:"",invitationCodeError:!1,areaCodes:[],agreement:!t,marketing:!t,auth:!1,redirect:"",loginTelegramBotId:"",loginDomain:"",queryParams:"",whiteCode:!1,oauthLogin:!1,prePathname:"",tgOneclick:!1}),o=M();let c=!0;H(()=>{if(c){c=!1;return}const i=a.areaCode.countryCode;i&&localStorage.setItem("mobileCode",i)}),D(()=>{const i=()=>d(this,null,function*(){yield P(),f.emit("track_login_success",{userId:String(m.userId)})}),n=()=>d(this,null,function*(){yield P(),f.emit("track_regist_success",{userId:String(m.userId)}),f.emit("sensorsTrack",{event:"_profile_set_once"})});f.on("signin-success",i),f.on("regist-success",n)}),D(()=>{s()}),H(()=>{o()&&!a.areaCodes&&s()});const s=()=>{Promise.all([h().get("/account/invitation-code/whitelist/"),K(),h().get("/account/open/unified-login-info/")]).then(i=>{if(i&&i.length===3){let n={};const g=i[1],C=i[2];if(g){const p=g.map(l=>$(v({},l),{value:l.areaCode}));let I=m.areaCode;const T=localStorage.getItem("mobileCode");if(T){const l=p.find(W=>W.countryCode==T);l&&(I=l.countryCode)}let b=p.find(l=>l.countryCode==I)||p[0];e&&(b=p.find(l=>l.areaCode==="254")||p[0]),b.areaCode!==a.areaCode.areaCode&&(n.areaCode=b),n.areaCodes=p}C&&(n.loginTelegramBotId=C.loginTelegramBotId,n.loginDomain=C.loginDomain,n.queryParams=C.queryParams),m.currentInvitationCode&&(n.invitationCode=m.currentInvitationCode||""),i[0]&&m.currentInvitationCode&&i[0].includes(m.currentInvitationCode)&&(n.whiteCode=!0),n&&r(v({},n))}}).catch(console.log)};return{state:a,onChange:r}}const ne=O(()=>ae());function de(){const{state:e}=ne,t=z();return(a=!1)=>d(this,null,function*(){const{isUsHost:r}=_.getHostType(u.host);if(a&&e.inIframe&&window.parent.postMessage({target:"bc-login",data:{type:"signup",code:200}},"*"),yield G(),window.opener!=null)window.opener.postMessage({event:"signin_success",data:"signin success"},"*"),t(e.prePathname||"/");else{e.redirect?e.redirect.startsWith("/")?t(decodeURIComponent(e.redirect),{replace:!0}):location.href=decodeURIComponent(e.redirect):e.auth?t("/",{replace:!0}):t(e.prePathname||"/"),e.tgOneclick&&ee();const o=Number(u.initSearchParams.get("sso_mode")||"0")===1;!e.oauthLogin&&o&&!r&&setTimeout(()=>{const c=u.initSearchParams.get("i")||"",s=u.initSearchParams.get("s")||"",i=u.initSearchParams.get("bcn")||"",n=e.loginDomain.split("//"),g=`${window.location.origin}/api/account/rotation/landing/?i=${c}&s=${s}&p=${encodeURIComponent(window.location.pathname)}&bcn=${i}&back=true&h=${n[n.length-1]}`;window.location.href=g},100)}})}export{ne as a,ge as c,ue as i,de as u};
